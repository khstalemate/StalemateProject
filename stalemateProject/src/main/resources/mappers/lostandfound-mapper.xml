<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.stale.mate.board.model.mapper.LostAndFoundMapper">

	<!-- 작성자 : 최보윤
		작성일자 : 2025-12-23
	 	실종, 목격 게시판의 총 게시글 개수 가져오기 -->
	<select id="getAllPostCount">
		SELECT COUNT(*) FROM POST
		WHERE MENU_NO = 2	
	</select>
	
	<!-- 작성자 : 최보윤
		작성일자 : 2025-12-23
		상태가 실종인 게시글의 개수 가져오기 -->
	<select id="getLostPostCount">
		SELECT COUNT(*) FROM POST
		WHERE MENU_NO = 2
		AND CATEGORY = '실종'
	</select>
	
	<!-- 작성자 : 최보윤
		작성일자 : 2025-12-23
		상태가 목격인 게시글의 개수 가져오기 -->
	<select id="getWitnessPostCount">
		SELECT COUNT(*) FROM POST
		WHERE MENU_NO = 2
		AND CATEGORY = '목격'
	</select>
	
	<!-- 작성자 : 최보윤
		작성일자 : 2025-12-23
		오늘 등록한 게시글의 개수 가져오기 -->
	<select id="getTodayPostCount">
		SELECT COUNT(*) FROM POST
		WHERE MENU_NO = 2
		AND TO_CHAR(POST_DATE, 'YYYYMMDD') = TO_CHAR(SYSDATE, 'YYYYMMDD')
	</select>
	
	<!-- 작성자 : 최보윤
		작성일자 : 2025-12-23
		게시글 목록 조회하기 -->
	<select id="selectPostList">
		SELECT POST_NO, CATEGORY, POST_TITLE, CONTENT, MEMBER_NAME AS "memberName", VIEWS, STATUS,
		<![CDATA[
		CASE
			WHEN SYSDATE - CAST(POST_DATE AS DATE) < 1 / 24 / 60
			THEN FLOOR((SYSDATE - CAST(POST_DATE AS DATE)) * 24 * 60 * 60) || '초 전'
			
			WHEN SYSDATE - CAST(POST_DATE AS DATE) < 1 / 24
			THEN FLOOR((SYSDATE - CAST(POST_DATE AS DATE)) * 24 * 60) || '분 전'
			
			WHEN SYSDATE - CAST(POST_DATE AS DATE) < 1
			THEN FLOOR((SYSDATE - CAST(POST_DATE AS DATE)) * 24) || '시간 전' 
			
			ELSE TO_CHAR(POST_DATE, 'YYYY.MM.DD')
		END POST_DATE
		]]>
		FROM POST
		JOIN MEMBER USING (MEMBER_NO)
		WHERE POST_DELETE = 'N'
		AND CATEGORY IN ('실종', '목격')
		ORDER BY POST_NO DESC
	</select>
	
	<!-- 작성자 : 최보윤
		작성일자 : 2025-12-24
		검색 결과에 부합하는 게시글 개수 가져오는 SQL -->
	<select id="getSearchCount">
		SELECT COUNT(*)
		FROM POST
		JOIN MEMBER USING (MEMBER_NO)
		WHERE POST_DELETE = 'N'
		AND MENU_NO = 2
		<if test="title != null and title != ''">
			AND POST_TITLE LIKE '%'||#{title}||'%'
		</if>
		<if test="writer != null and writer != ''">
			AND MEMBER_NAME LIKE '%'||#{writer}||'%'
		</if>
		<choose>
			<when test='category=="missing"'>
				AND CATEGORY = '실종'
			</when>
			<when test='category=="witness"'>
				AND CATEGORY = '목격'
			</when>
			<otherwise>
				AND CATEGORY IN ('실종', '목격')
			</otherwise>
		</choose>
		<if test="status != null and status != ''">
			AND STATUS = #{status}
		</if>
		<if test="species != null and species != ''">
			AND SPECIES = #{species}
		</if>
		<if test="gender != null and gender != ''">
			AND GENDER = #{gender}
		</if>
		<if test="age != null and age != ''">
			AND AGE = #{age}
		</if>
		<if test="weight != null and weight != ''">
			AND WEIGHT = #{weight}
		</if>
		ORDER BY POST_NO DESC
	</select>
	
	<!-- 작성자 : 최보윤
		작성일자 : 2025-12-24
		검색 결과에 부합하는 게시글 목록 조회하기 -->
	<select id="selectSearchList">
		SELECT CATEGORY, POST_TITLE, MEMBER_NAME AS "memberName", VIEWS, STATUS,
      	<![CDATA[
		CASE
			WHEN SYSDATE - CAST(POST_DATE AS DATE) < 1 / 24 / 60
			THEN FLOOR((SYSDATE - CAST(POST_DATE AS DATE)) * 24 * 60 * 60) || '초 전'
			
			WHEN SYSDATE - CAST(POST_DATE AS DATE) < 1 / 24
			THEN FLOOR((SYSDATE - CAST(POST_DATE AS DATE)) * 24 * 60) || '분 전'
			
			WHEN SYSDATE - CAST(POST_DATE AS DATE) < 1
			THEN FLOOR((SYSDATE - CAST(POST_DATE AS DATE)) * 24) || '시간 전' 
			
			ELSE TO_CHAR(POST_DATE, 'YYYY.MM.DD')
		END POST_DATE
		]]>
      	FROM POST
      	JOIN MEMBER USING (MEMBER_NO)
      	WHERE POST_DELETE = 'N'
      	AND MENU_NO = 2
      	<if test="title != null and title != ''">
        	 AND POST_TITLE LIKE '%'||#{title}||'%'
      	</if>
      	<if test="writer != null and writer != ''">
      	   AND MEMBER_NAME LIKE '%'||#{writer}||'%'
      	</if>
      	<choose>
        	 <when test='category=="missing"'>
            	AND CATEGORY = '실종'
         	</when>
         	<when test='category=="witness"'>
            	AND CATEGORY = '목격'
         	</when>
         	<otherwise>
	            AND CATEGORY IN ('실종', '목격')
         	</otherwise>
      	</choose>
      	<if test="status != null and status != ''">
        	 AND STATUS = #{status}
      	</if>
      	<if test="species != null and species != ''">
         	AND SPECIES = #{species}
      	</if>
      	<if test="gender != null and gender != ''">
         	AND GENDER = #{gender}
      	</if>
      	<if test="age != null and age != ''">
         	AND AGE = #{age}
      	</if>
      	<if test="weight != null and weight != ''">
         	AND WEIGHT = #{weight}
      	</if>
      	ORDER BY POST_NO DESC
	</select>
	
	<!-- 작성자 : 최보윤
	작성일자 : 2025-12-28
	게시글 상세 조회 -->
	<select id="getPost">
		SELECT POST_TITLE, CATEGORY, STATUS, VIEWS, LOCATION, DETAIL_LOCATION, SPECIES, GENDER, AGE, WEIGHT, CONTENT, MEMBER_NAME AS "memberName",
		TO_CHAR(MISSING_DATE, 'YYYY"년" MM"월" DD"일"') AS MISSING_DATE,
		TO_CHAR(MISSING_TIME, 'HH24:MI') AS MISSING_TIME,
		TO_CHAR(POST_DATE, 'YYYY"년" MM"월" DD"일"') AS POST_DATE
		FROM POST
		JOIN MEMBER USING(MEMBER_NO)
		WHERE POST_NO = #{postNo}
		AND MENU_NO = 2
		AND POST_DELETE = 'N'
	</select>
	
	<!-- 작성자 : 최보윤
	작성일자 : 2025-12-28
	게시글 삽입(이미지 제외) -->
	<insert id="insertPost" useGeneratedKeys="true" parameterType="Post">
		<selectKey order="BEFORE" resultType="_int" keyProperty="postNo">
			SELECT SEQ_POST.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO POST
		VALUES (#{postTitle}, #{category}, #{missingDate}, #{missingTime}, #{location},
		#{detail_location}, #{species}, #{gender}, #{age}, #{weight}, #{content})
	</insert>
		
	<!-- 작성자 : 최보윤
	작성일자 : 2025-12-28
	게시글 삽입(이미지) -->
	<insert id="insertUploadList">
		INSERT INTO POST_IMG
		<foreach collection="list" item="img" open="(" close=")" separator=" UNION ">
		</foreach>
	</insert>
</mapper>